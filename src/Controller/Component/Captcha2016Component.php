<?php
namespace App\Controller\Component;
use Cake\Controller\Component;

class CaptchaComponent extends Component{
	public $char = [ 
		'-' => [".........",".........",".........",".........",".#######.",".........",".........",".........","........."],
		'0' => [".........","..#####..",".#....##.",".#...#.#.",".#..#..#.",".#.#...#.",".##....#.","..#####..","........."],
		'1' => [".........",".....###.","....####.","...##.##.","..##..##.","......##.","......##.","......##.","........."],
		'2' => [".........","..#####..",".##...##.",".....##..","....##...","...##....","..##.....",".#######.","........."],
		'3' => [".........","..#####..",".##...##.","......##.",".....##..","......##.",".##...##.","..#####..","........."],
		'4' => [".........",".....##..","....##...","...##....","..##.##..",".#######.",".....##..",".....##..","........."],
		'5' => [".........",".#######.",".##......",".##......",".######..","......##.",".#....##.","..#####..","........."],
		'6' => [".........","..#####..",".##......",".##......",".######..",".##...##.",".##...##.","..#####..","........."],
		'7' => [".........",".#######.","......##.",".....##..","..######.","...##....","..##.....",".##......","........."],
		'8' => [".........","..#####..",".##...##.",".##...##.","..#####..",".##...##.",".##...##.","..#####..","........."],
		'9' => [".........","..#####..",".##...##.",".##...##.","..######.","......##.",".#....##.","..#####..","........."],
		'A' => [".........","..#####..",".##...##.",".##...##.",".#######.",".##...##.",".##...##.",".##...##.","........."],
		'B' => [".........",".######..",".##...##.",".##...##.",".#####...",".##...##.",".##...##.",".######..","........."],
		'C' => [".........","..#####..",".##...##.",".##......",".##......",".##......",".##...##.","..#####..","........."],
		'D' => [".........",".#####...",".##...##.",".##...##.",".##...##.",".##...##.",".##...##.",".#####...","........."],
		'E' => [".........",".#######.",".##......",".##......",".#####...",".##......",".##......",".#######.","........."],
		'F' => [".........",".#######.",".##......",".##......",".#####...",".##......",".##......",".##......","........."],
		'G' => [".........","..#####..",".##...##.",".##......",".##.###..",".##...##.",".##...##.","..#####..","........."],
		'H' => [".........",".##...##.",".##...##.",".##...##.",".#######.",".##...##.",".##...##.",".##...##.","........."],
		'I' => [".........","....##...",".........","....##...","....##...","....##...","....##...","....##...","........."],
		'J' => [".........","......##.",".........","......##.","......##.","......##.",".##...##.","..####...","........."],
		'K' => [".........",".##...##.",".##..##..",".##.##...",".####....",".##.##...",".##..##..",".##...##.","........."],
		'L' => [".........",".##......",".##......",".##......",".##......",".##......",".##......",".#######.","........."],
		'M' => [".........",".##...##.",".#.#.#.#.",".#..#..#.",".#.....#.",".#.....#.",".#.....#.",".#.....#.","........."],
		'N' => [".........",".#.....#.",".##....#.",".#.#...#.",".#..#..#.",".#...#.#.",".#....##.",".#.....#.","........."],
		'O' => [".........","..#####..",".#.....#.",".#.....#.",".#.....#.",".#.....#.",".#.....#.",".#.....#.","..#####.."],
		'P' => [".........",".######..",".##....#.",".##....#.",".######..",".##......",".##......",".##......","........."],
		'R' => [".........",".######..",".##...##.",".##...##.",".#####...",".##.##...",".##..##..",".##...##.","........."],
		'S' => [".........","..#####..",".#.....#.",".#.......","..#####..",".......#.",".#.....#.","..#####..","........."],
		'T' => [".........",".#######.","....#....","....#....","....#....","....#....","....#....","....#....","........."],
		'U' => [".........",".##...##.",".##...##.",".##...##.",".##...##.",".##...##.",".##...##.","..#####..","........."],
		'V' => [".........",".#.....#.",".#.....#.",".#.....#.",".#.....#.","..#...#..","...#.#...","....#....","........."],
		'X' => [".........",".#.....#.","..#...#..","...#.#...","....#....","...#.#...","..#...#..",".#.....#.","........."],
		'Y' => [".........",".#.....#.","..#...#..","...#.#...","....#....","....#....","....#....","....#....","........."],
		'Z' => [".........",".#######.","......#..",".....#...","....#....","...#.....","..#......",".#######.","........."],
	];

	public function generateRandomString($length = 8) {
	    //$characters = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
	    //$characters = "0123456789ABCDEFGHIJKLMNOPRSTUVXYZ";
	    $characters = "123456789ABCDEFGHIJKLMNPRSTUVXYZ";
	    $charactersLength = strlen($characters);
	    $randomString = '';
	    for ($i = 0; $i < $length; $i++) {
	        $randomString .= $characters[rand(0, $charactersLength - 1)];
	    }
	    //return '123456789A';
	    //return 'BCDEFGHIJK';
	    //return 'LMNPRSTUVX';
	    //return 'NPRSTUVXYZ';
	    return $randomString;
	}

	//---------------- Session-ből visszaadja a CAPTCHA értékét -------------------
	public function getCaptcha(){
		return $this->request->session()->read('captcha');
	}

    //---------------- CAPTCHA-t generál -------------------
    public function generateCaptcha($length=4, $maxDistance=7){
    	$captcha = "";
    	$bg 	 = "ABCDEF";
    	$fg 	 = "";
		$randStr = $this->generateRandomString( $length );
		$this->request->session()->write(['captcha' => $randStr]);
		for($c=0;$c<=5;$c++){
			$fg .= rand(0,9);
		}
		$distance = [];
		for($d=0;$d<$length;$d++){
			$distance[$d] = rand(0, $maxDistance);
		}
		$fullspace = ".................................";
		for($j=0;$j<=8;$j++){
			for($i=0;$i<=$length-1;$i++){
				$c = $randStr[$i];
				$space = substr($fullspace, 0, $distance[$i]);
				$captcha .= $space.$this->char[$c][$j].$space;
			}
			$captcha .= "<br>\n";
		}
		$recaptcha = "";
		for($i=0;$i<=strlen($captcha)-1;$i++){
			if($captcha[$i]!='<' && $captcha[$i]!='b' && $captcha[$i]!='r' && $captcha[$i]!='>' && $captcha[$i]!="\n"){
				$bgColor = "";
				$fgColor = "";
				for($c=0;$c<=5;$c++){
					$bgColor .= $bg[rand(0,5)];
					$fgColor .= $fg[rand(0,4)];
				}

				if($captcha[$i]=="."){				
					$randChar = $this->generateRandomString( 1 );	
					$randChar = " ";
					$recaptcha .= '<span style="color:'.$bgColor.';">'.$randChar.'</span>';
				}
				if($captcha[$i]=="#"){
					$randChar = $this->generateRandomString( 1 );
					$randChar = "■";
					$recaptcha .= '<span style="color:'.$fgColor.';">'.$randChar.'</span>';
				}
			}else{
				$recaptcha .= $captcha[$i];
			}
		}
		$captcha = $recaptcha;
		return $captcha;
    }
}

?>